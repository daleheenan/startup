name: Railway Deployment Monitor

on:
  # Run after deployment (trigger from Railway webhook or manual)
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check'
        required: true
        default: 'health'
        type: choice
        options:
          - health
          - full

  # Schedule to run every hour during business hours
  schedule:
    - cron: '0 8-20 * * 1-5'  # Every hour, 8am-8pm, Mon-Fri

env:
  BACKEND_URL: ${{ vars.BACKEND_URL || 'https://novelforge-backend-production.up.railway.app' }}

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Check backend health
        id: health
        run: |
          echo "Checking backend health at $BACKEND_URL/api/health..."

          RESPONSE=$(curl -s -w "\n%{http_code}" "$BACKEND_URL/api/health" || echo -e "\n000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "Backend is healthy!"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "Backend health check failed!"
          fi

      - name: Check critical endpoints
        if: steps.health.outputs.status == 'healthy'
        run: |
          echo "Testing critical endpoints..."

          # Endpoints that should return 401 (auth required) but NOT 500
          ENDPOINTS=(
            "/api/projects"
            "/api/user/settings"
            "/api/user/genre-preferences"
          )

          FAILURES=0

          for endpoint in "${ENDPOINTS[@]}"; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL$endpoint" || echo "000")

            if [ "$RESPONSE" = "500" ]; then
              echo "FAIL: $endpoint returned 500 (server error)"
              FAILURES=$((FAILURES + 1))
            elif [ "$RESPONSE" = "000" ]; then
              echo "FAIL: $endpoint - connection failed"
              FAILURES=$((FAILURES + 1))
            else
              echo "OK: $endpoint returned $RESPONSE"
            fi
          done

          if [ $FAILURES -gt 0 ]; then
            echo ""
            echo "ERROR: $FAILURES endpoint(s) are failing!"
            exit 1
          fi

          echo ""
          echo "All endpoints responding correctly"

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Railway Backend Health Check Failed';
            const body = `## Automated Health Check Failed

            **Time:** ${new Date().toISOString()}
            **Backend URL:** ${process.env.BACKEND_URL}

            ### What happened
            The automated health check detected issues with the production backend.

            ### Suggested actions
            1. Check Railway logs: \`railway logs\`
            2. Run local diagnostics: \`./scripts/check-railway-logs.ps1\`
            3. Check recent deployments in Railway dashboard
            4. Review recent commits for potential issues

            ### Common fixes
            - Database migration issues: Check \`backend/src/db/migrate.ts\`
            - Missing tables: Ensure all .sql files are registered
            - Environment variables: Verify Railway env vars are set

            ---
            *This issue was created automatically by the Railway Monitor workflow.*`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'production-issue'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            if (existingIssue) {
              // Add a comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Health check failed again at ${new Date().toISOString()}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['production-issue', 'bug', 'automated']
              });
            }

  database-check:
    name: Database Schema Check
    runs-on: ubuntu-latest
    needs: health-check

    steps:
      - uses: actions/checkout@v4

      - name: Verify migration consistency
        run: |
          echo "Verifying migration file consistency..."

          # Count files in migrations directory
          FILE_COUNT=$(ls -1 backend/src/db/migrations/*.sql 2>/dev/null | wc -l)

          # Count entries in migrate.ts (rough count)
          REGISTERED_COUNT=$(grep -c "\.sql'" backend/src/db/migrate.ts || echo "0")

          echo "Migration files in directory: $FILE_COUNT"
          echo "Migrations referenced in code: $REGISTERED_COUNT"

          # The numbers won't match exactly due to inline migrations (002-004)
          # But if there's a big difference, something is wrong
          DIFF=$((FILE_COUNT - REGISTERED_COUNT))
          if [ $DIFF -gt 5 ] || [ $DIFF -lt -5 ]; then
            echo "WARNING: Large discrepancy between migration files and registrations"
            echo "This may indicate missing or orphaned migrations"
          fi
